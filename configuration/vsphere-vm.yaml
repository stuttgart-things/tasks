---
version: 3

dotenv:
  - .env

tasks:
  render-vsphere-vm-config:
    desc: Render vSphere VM configuration and create PR using Dagger
    vars:
      MODULE: /home/sthings/projects/blueprints/configuration #github.com/stuttgart-things/blueprints/configuration
      VERSION: v1.34.1
      FUNCTION: vsphere-vm
      ENV:
        sh: |
          ls configs/*.yaml | xargs -n1 basename | sed 's/.yaml//' | gum choose --header "Select vSphere Environment"
      VM_NAME:
        sh: |
          gum input --prompt "VM Name: " --placeholder "e.g. demo-infra1, web-server-prod"
      VM_COUNT:
        sh: |
          gum choose --header "Number of VMs" "1" "2" "3" "4" "5"
      VM_RAM:
        sh: |
          gum choose --header "RAM (GB)" "6" "8" "12" "16" "24"
      VM_TEMPLATE:
        sh: |
          gum choose --header "Select VM Template" $(yq eval '.templates[]' configs/{{ .ENV }}.yaml)
      VM_DISK:
        sh: |
          gum choose --header "Disk Size (GB)" "32" "64" "96" "128" "192" "256"
      VM_CPU:
        sh: |
          gum choose --header "CPU Cores" "4" "6" "8" "12" "16"
      VM_FIRMWARE:
        sh: |
          gum choose --header "Select Firmware Type" "bios" "efi"
      VM_FOLDER:
        sh: |
          gum choose --header "Select VM Folder" $(yq eval '.vmFolders[]' configs/{{ .ENV }}.yaml)
      NETWORK:
        sh: |
          yq eval '.networks[] | .name + "|" + .path' configs/{{ .ENV }}.yaml | \
          gum choose --header "Select Network" | \
          cut -d'|' -f2
      DATACENTER:
        sh: |
          yq eval '.datacenter' configs/{{ .ENV }}.yaml
      DATASTORE:
        sh: |
          yq eval '.datastores[]' configs/{{ .ENV }}.yaml | gum choose --header "Select Datastore"
      RESOURCE_POOL:
        sh: |
          yq eval '.resourcePool' configs/{{ .ENV }}.yaml
      VAULT_SECRET_PATH:
        sh: |
          yq eval '.vaultSecretPath' configs/{{ .ENV }}.yaml
      USE_VAULT:
        sh: |
          gum choose --header "Use HashiCorp Vault for credentials?" --selected="false" "true" "false"
      COMMIT_CONFIG:
        sh: |
          gum choose --header "Commit configuration to Git?" --selected="true" "true" "false"
      REPOSITORY:
        sh: |
          if [ "{{ .COMMIT_CONFIG }}" = "false" ]; then
            echo ""
          else
            gum input --prompt "GitHub Repository: " --value "${GITHUB_REPOSITORY:-stuttgart-things/blueprints}" --placeholder "org/repo"
          fi
      CREATE_BRANCH:
        sh: |
          if [ "{{ .COMMIT_CONFIG }}" = "false" ]; then
            echo "false"
          else
            gum choose --header "Create new branch?" --selected="true" "true" "false"
          fi
      BRANCH_NAME:
        sh: |
          if [ "{{ .COMMIT_CONFIG }}" = "false" ]; then
            echo ""
          else
            gum input --prompt "Branch Name: " --value "feat/vm-{{ .VM_NAME }}" --placeholder "Git branch to create/use"
          fi
      COMMIT_MESSAGE:
        sh: |
          if [ "{{ .COMMIT_CONFIG }}" = "false" ]; then
            echo ""
          else
            gum input --prompt "Commit Message: " --value "Add vSphere VM configuration for {{ .VM_NAME }} in {{ .ENV }}"
          fi
      DESTINATION_FOLDER:
        sh: |
          if [ "{{ .COMMIT_CONFIG }}" = "false" ]; then
            echo ""
          else
            gum input --prompt "Destination Folder: " --value "{{ .VM_NAME }}-{{ .ENV }}" --placeholder "Folder name in repository"
          fi
      DESTINATION_BASE_PATH:
        sh: |
          if [ "{{ .COMMIT_CONFIG }}" = "false" ]; then
            echo ""
          else
            gum input --prompt "Base Path: " --value "./" --placeholder "Base path in repository"
          fi
      AUTHOR_NAME:
        sh: |
          if [ "{{ .COMMIT_CONFIG }}" = "false" ]; then
            echo ""
          else
            gum input --prompt "Author Name: " --value "$(git config user.name)" --placeholder "Your full name"
          fi
      AUTHOR_EMAIL:
        sh: |
          if [ "{{ .COMMIT_CONFIG }}" = "false" ]; then
            echo ""
          else
            gum input --prompt "Author Email: " --value "$(git config user.email)" --placeholder "your.email@example.com"
          fi
      CREATE_PR:
        sh: |
          if [ "{{ .COMMIT_CONFIG }}" = "false" ]; then
            echo "false"
          else
            gum choose --header "Create Pull Request?" --selected="true" "true" "false"
          fi
      PR_TITLE:
        sh: |
          if [ "{{ .CREATE_PR }}" = "false" ] || [ "{{ .COMMIT_CONFIG }}" = "false" ]; then
            echo ""
          else
            gum input --prompt "PR Title: " --value "Add vSphere VM configuration for {{ .VM_NAME }} in {{ .ENV }}"
          fi
      EXPORT_PATH:
        sh: |
          gum input --prompt "Export Path: " --value "/tmp/exports/{{ .VM_NAME }}" --placeholder "Local export directory"
    cmds:
      - |
        echo "üöÄ Rendering vSphere VM configuration..."
        echo "   Environment: {{ .ENV }}"
        echo "   VM Name: {{ .VM_NAME }}"
        echo "   Count: {{ .VM_COUNT }}"
        echo "   Resources: {{ .VM_CPU }} vCPU, {{ .VM_RAM }} GB RAM, {{ .VM_DISK }} GB Disk"
        echo ""
      - |
        PR_BODY="This PR adds the rendered vSphere VM configuration for {{ .VM_NAME }} in {{ .ENV }} environment.

        Environment: {{ .ENV }}
        VM Name: {{ .VM_NAME }}
        VM Count: {{ .VM_COUNT }}
        Resources: {{ .VM_CPU }} vCPU, {{ .VM_RAM }} GB RAM, {{ .VM_DISK }} GB Disk"

        #@{{ .VERSION }}

        dagger call -m {{ .MODULE }} {{ .FUNCTION }} \
        --src ./ \
        --config-parameters "name={{ .VM_NAME }},count={{ .VM_COUNT }},ram=$(({{ .VM_RAM }} * 1024)),template={{ .VM_TEMPLATE }},disk={{ .VM_DISK }},cpu={{ .VM_CPU }},firmware={{ .VM_FIRMWARE }},vm_folder={{ .VM_FOLDER }},datacenter={{ .DATACENTER }},datastore={{ .DATASTORE }},resourcePool={{ .RESOURCE_POOL }},network={{ .NETWORK }},useVault={{ .USE_VAULT }},vaultSecretPath={{ .VAULT_SECRET_PATH }},ansibleRequirementsFile=./requirements.yaml" \
        --token=env:GITHUB_TOKEN \
        --repository "{{ .REPOSITORY }}" \
        --branch-name "{{ .BRANCH_NAME }}" \
        --commit-message "{{ .COMMIT_MESSAGE }}" \
        --destination-folder "{{ .DESTINATION_FOLDER }}" \
        --destination-base-path "{{ .DESTINATION_BASE_PATH }}" \
        --author-name "{{ .AUTHOR_NAME }}" \
        --author-email "{{ .AUTHOR_EMAIL }}" \
        --pull-request-title "{{ .PR_TITLE }}" \
        --pull-request-body "$PR_BODY" \
        --create-branch={{ .CREATE_BRANCH }} \
        --commit-config={{ .COMMIT_CONFIG }} \
        --create-pull-request={{ .CREATE_PR }} \
        export --path={{ .EXPORT_PATH }}
      - |
        echo ""
        echo "‚úÖ Configuration rendered successfully!"
        echo "   Exported to: {{ .EXPORT_PATH }}"

  list-environments:
    desc: List all available vSphere environments
    cmds:
      - |
        echo "üìã Available vSphere Environments:"
        echo ""
        for config in configs/*.yaml; do
          env=$(basename "$config" .yaml)
          dc=$(yq eval '.datacenter' "$config")
          echo "  ‚Ä¢ $env"
          echo "    Datacenter: $dc"
          echo ""
        done

  show-environment:
    desc: Show details of a specific environment
    vars:
      ENV:
        sh: |
          ls configs/*.yaml | xargs -n1 basename | sed 's/.yaml//' | gum choose --header "Select environment to view"
    cmds:
      - |
        echo "üåê Environment: {{ .ENV }}"
        echo ""
        echo "Datacenter: $(yq eval '.datacenter' configs/{{ .ENV }}.yaml)"
        echo "Resource Pool: $(yq eval '.resourcePool' configs/{{ .ENV }}.yaml)"
        echo ""
        echo "üì¶ Datastores:"
        yq eval '.datastores[]' configs/{{ .ENV }}.yaml | sed 's/^/  ‚Ä¢ /'
        echo ""
        echo "üåê Networks:"
        yq eval '.networks[] | "  ‚Ä¢ " + .name' configs/{{ .ENV }}.yaml
        echo ""
        echo "üìÄ Templates:"
        yq eval '.templates[]' configs/{{ .ENV }}.yaml | sed 's/^/  ‚Ä¢ /'
        echo ""
        echo "üìÅ VM Folders:"
        yq eval '.vmFolders[]' configs/{{ .ENV }}.yaml | sed 's/^/  ‚Ä¢ /'

  validate-configs:
    desc: Validate all environment configuration files
    cmds:
      - |
        echo "üîç Validating configuration files..."
        echo ""
        for config in configs/*.yaml; do
          env=$(basename "$config" .yaml)
          echo -n "Checking $env... "
          if yq eval '.' "$config" > /dev/null 2>&1; then
            echo "‚úÖ"
          else
            echo "‚ùå Invalid YAML"
            exit 1
          fi
        done
        echo ""
        echo "‚úÖ All configurations are valid!"
